<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>
<project
xmlns:git="antlib:com.rimerosolutions.ant.git">
  <target name="build.submodules" depends="init,git-clone">
    <concatenate-dependencies lineparam="${dependencies}" base="${core.lib.dir}/"/>
  </target>

  <target name="test.travis" depends="build.submodules,test"> <!-- depends: build.submodules, -->
  </target>

<!--  <ivy:cachepath pathid="ant.git.tasks.classpath" conf="YOUR_IVY_CONFIGURATION"/> -->

  <target name="init-git" depends="resolve" description="Initialize git.">
    <taskdef uri="antlib:com.rimerosolutions.ant.git" resource="com/rimerosolutions/ant/git/jgit-ant-lib.xml">
      <classpath refid="dist.path"/>
    </taskdef>
  </target>
  
  <macrodef name="compile-dependency">
    <attribute name="repository"/>
    <sequential>
      <delete dir="${build.dir}/tmp/git-deps/@{repository}"/>
      <mkdir dir="${build.dir}/tmp/git-deps/@{repository}"/>
      <echo>Cloning @{repository}.</echo>
      <git:git directory="${build.dir}/tmp/git-deps/@{repository}" verbose="false">
        <git:clone uri="https://github.com/@{repository}.git" />
      </git:git>
      <echo>Compiling @{repository}.</echo>
      <subant target="dist-rc-git" antfile="build.xml" buildpath="${build.dir}/tmp/git-deps/@{repository}"/>
      <echo>Copying library</echo>
      <copy todir="${core.lib.dir}">
        <fileset dir="${build.dir}/tmp/git-deps/@{repository}/${dist.dir}" includes="**/*.jar" />
      </copy>
      <copy todir="${build.dir}/tmp/git-deps/lib">
        <fileset dir="${build.dir}/tmp/git-deps/@{repository}/${dist.dir}" includes="**/*.jar" />
      </copy>
      <echo>Cleaning up build direcotry.</echo>
      <!--<delete dir="${build.dir}/tmp/git-deps/@{repository}" failonerror="false"/>-->
    </sequential>
  </macrodef>

  <!-- concatenates the zet dependencies into a custom classpath -->
  <macrodef name="concatenate-dependencies">
    <attribute name="lineparam"/>
    <attribute name="base"/>
    <sequential>
      <var name="classpath.custom" value="" /> <!-- Defined a variable with null value --> 
      <for list="@{lineparam}" param="dependency">
        <sequential>
          <echo>Depends on @{dependency}</echo>
          <!-- pattern: 
               ../../lib/zetool-common-rc.jar:\ -->
          <var name="classpath.custom" value="${classpath.custom}@{base}@{dependency}-rc.jar:" /> 
        </sequential>
      </for>
      <echo>classpath.custom: ${classpath.custom}</echo>
    </sequential>
  </macrodef>

  <target name="build.git" depends="init-ant-contrib">
    <concatenate-dependencies lineparam="${dependencies}" base="../../lib/"/>
  </target>

  <target name="dist-rc-git" depends="build.git,dist-rc" description="generating dist and test" >
  </target>

  <macrodef name="make-github">
    <sequential>
      <replaceproperty src="dependencies" dest="dependencies-tmp-make-github" replace="zetool-" with="zetool/"/>
      <replaceproperty src="dependencies-tmp-make-github" dest="dependencies-github" replace="zet-" with="zet/"/>
    </sequential>
  </macrodef>
 
  <target name="git-clone" depends="init-git,init-ant-contrib">
    <mkdir dir="${build.dir}/tmp/git-deps"/>
    <echo>Cloning depending git directories:</echo>
    <make-github/>
    <echo>${dependencies-github}</echo>
    <for list="${dependencies-github}" param="dependency">
      <sequential>
        <echo>Depends on @{dependency}</echo>
        <compile-dependency repository="@{dependency}"/>
      </sequential>
    </for>
    <!--<delete dir="${build.dir}/tmp/git-deps" failonerror="false"/>-->
  </target>

</project>